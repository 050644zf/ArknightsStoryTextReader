<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title></title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet" type="text/css" href="reader.css">
    </head>
    <body>
        <script src="script.js"></script>
        <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
        <script src="https://unpkg.com/vue@next"></script>
        <script src="i18n.js"></script>

        <div id="header" class="header">
            Arknights Story Text Reader 
            <span style="font-size: medium;font-weight: normal;">
                 <a href="https://github.com/050644zf/ArknightsStoryTextReader/blob/master/ASTR/CHANGELOG.md" style="font-weight: bold;text-decoration: underline;">wv0.7</a>
                 by nightsky#3319 on 
                 <a href="https://discord.gg/rihq" style="font-weight: bold;text-decoration: underline;">Rhodes Island HQ</a>
                </span>
        </div>
        <div id="warning" class="warning" onclick="this.style.display = 'none'">
            Arknights Story Text Reader is currently under development. The interface and features may receive great changes in the future. If you have any issues or feedbacks please summit it 
            <a href="https://github.com/050644zf/ArknightsStoryTextReader/issues">here.</a></br>
            </br>
            <b>Click this message to remove it.</b>
        </div>
        
        <span class="material-icons topButton" onclick="document.getElementById('storydata').scrollIntoView({behavior: 'smooth', block:'center'})">vertical_align_top</span>

        <div id='content' class="content">
            <div id="setting">
                <div class="warmtip" style="background-color: rgb(255, 255, 0);color: #000; padding: 5px;" v-show="!hidetip">
                    <span style="float: left;">If you like this project, please give me a star <a href="https://github.com/050644zf/ArknightsStoryTextReader" style="color: rgb(32, 32, 184);">here</a>!</span>
                    <span class="material-icons" style="float: right;" @click="hide()">clear</span>
                    <div style="clear: both;"></div>
                </div>
                <div :class="{setting:true,settingshow:show}">
                    <span :class="{'material-icons':true}" @click="show = !show"  id="settingbutton">
                        settings
                    </span>
                    <span class="settingtitle">{{i18n.setting[lang]}}</span>
                    
                    <span class="material-icons" style="float: right;padding: 4px;" v-show="show" @click="clearSetting()">delete</span>
                    <span class="settingtitle" style="float: right; font-weight: normal;font-size: 15px;">{{i18n.clear[lang]}}: </span>
                    <div style="clear: both;"></div>
                    <div :class="{settingoptions:true}" v-show="show">
                        <span style="float: left;">{{i18n.dr[lang] }}: </span>
                        <input v-model="doctor" style="float: left;"/>
                        <span class="material-icons" @click="saveName()" style="float: left;">save_alt</span>
                        <div style="clear: both;"></div>
                    </div>
                </div>
                
                
            </div>

            <div id="list-rendering">
                <div class="storydata" id="storydata">
                    {{data.eventName}}  {{data.storyCode}}  {{data.avgTag}}  {{data.storyName}}
                </div>
                  <div v-for="line in data.storyList" :key="line.id" class="line" :id="'line'+line.id">
                    <a :href="getURL(lang,path,line.id)" class="linkButton material-icons">link</a>
                      <div v-if="line.prop == 'name'" class="textblock">
                          <div class="nameblock">{{line.attributes.name}}</div>
                          <div class="contentblock" v-html="parseContent(line.attributes.content)"></div>
                      </div>
                      <div v-if="line.prop == 'Subtitle'" :class="line.prop" :style="{'text-align': line.attributes.alignment}" v-html="parseContent(line.attributes.text)">
                      </div>
                      <div v-if="line.prop == 'Decision'" :class="line.prop">
                          <div v-for="(option, index) in line.attributes.values.split(';')" class="option" @click="jumpTo(line.targetLine['option'+option])" @mouseover="changeColor(line.targetLine['option'+option],'rgba(255,255,255,0.4)')" @mouseout="changeColor(line.targetLine['option'+option],'rgba(0,0,0,0.4)')" v-html="parseContent(line.attributes.options.split(';')[index])">
                              
                          </div>
                      </div>
                      <div v-if="line.prop == 'Predicate'" :class="line.prop">
                            <div v-if="!line.endOfOpt" class="optText">Options: {{line.attributes.references.replaceAll(';',' ')}}</div>
                            <div v-if="!line.endOfOpt" class="toEnd" @click="jumpTo(line.targetLine)" @mouseover="changeColor(line.targetLine,'rgba(255,255,255,0.4)')" @mouseout="changeColor(line.targetLine,'rgba(0,0,0,0.4)')">End of options</div>
                            <div v-else class="optText">End of Options</div>
                          
                      </div>

                      <img v-if="line.prop == 'Image' && line.attributes.image" class="Image" :src="'https://aceship.github.io/AN-EN-Tags/img/avg/images/'+line.attributes.image+'.png'"></img>
                      
                      <div style="clear: both;"></div>
                  </div>
            </div>
        </div>
        <div id="sidebar">
            <div :class="{menuButton:true,'material-icons':true,menuButtonR:showMenu}" @click="showMenu=!showMenu;">chevron_right</div>
            <div :class="{sidebar:true, sidebarhidden:!showMenu}" >
                <div id="currentLang" class="currentLang">
                    {{i18n.currentLang[lang]}}: {{i18n.langs[lang]}}
                    <div id="langSelect" class="langSelect">
                        <div  v-for="(langtext,langCode,lidx) in i18n.langs" @click="langSwitch(langCode)">
                            {{langtext}}
                        </div>
                    </div>
                </div>
                
                <div v-for="(events, eventType, ETidx) in eventList" class="eventType" :id="eventType">
                    <div class="eventtype" >{{i18n[eventType][lang]}}</div>
                    
                    <eventmenu v-for="(event, Eidx) in events" class="event" :id="event.id" :event="event" :sl="sl" :lang="lang" @hidemenu="showMenu=false"></eventmenu>
                </div>
            </div>
        </div>

        <script type="text/x-template" id="eventmenu">
            <div class="event">
                <div :class="{eventname:true, eventnamehl:!collapsed}" @click="collapsed = !collapsed" >{{event.name}}</div>
                <div class="stories" v-show="!collapsed">
                    <storymenu v-for="(story, STidx) in event.infoUnlockDatas" :story="story" :sl="sl" :lang="lang" @unfoldevent="collapsed = false"></storymenu>
                </div>
            </div>
        </script>

        <script type="text/x-template" id="storymenu">

            <div :class="{story:true, storyFocused:focused}" :id="story.storyId" @click="loadStory(sl, lang, story.storyTxt, showMenu)">
                <div class="storycode">{{story.storyCode}}  {{story.avgTag}} </div>
                <div class="storyname">{{story.storyName}}</div>
            </div>

        </script>

        <script>
            const color_re = /<color=([\w#]+)>(.+?)<\/color>/gm;
            const color_sub = `<span style="color:$1">$2</span>`;
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            var l = urlParams.get('l')
            var doctor = window.localStorage.getItem('doctor');
            var hidetip = window.localStorage.getItem('hidetip');
            if(!l){l = 'zh_CN'}
            if(!doctor){doctor = "{@nickname}"}
            if(!hidetip){hidetip = false};

            const setApp = Vue.createApp({
                data(){
                    return{
                        doctor: doctor,
                        i18n:i18n,
                        lang:l,
                        show: doctor == "{@nickname}",
                        hidetip: hidetip
                    }
                },
                methods:{
                    saveName(){
                        window.localStorage.setItem('doctor',this.doctor);
                        window.location.href = window.location.href;
                    },
                    clearSetting(){
                        window.localStorage.clear();
                        window.location.href = window.location.href;
                    },
                    hide(){
                        this.hidetip = true;
                        window.localStorage.setItem('hidetip', true);
                    }
                }
            })
            const setting = setApp.mount('#setting');
            
            function getEventList(reviewData, chardict){
                var eventList = {main:[], ss:[], mini:[], or:[]};
                for(event in reviewData){
                    if(reviewData[event].entryType == 'MAINLINE'){
                        eventList.main.push(reviewData[event]);
                    }
                    else if(reviewData[event].entryType == 'ACTIVITY'){
                        eventList.ss.push(reviewData[event]);
                    }
                    else if(reviewData[event].entryType == 'MINI_ACTIVITY'){
                        eventList.mini.push(reviewData[event]);
                    }
                    else if(reviewData[event].entryType == 'NONE'){
                        var cin = event.split('_')[1];
                        var set = event.split('_')[3];
                        reviewData[event].name = chardict[cin] + ' - ' + set;
                        eventList.or.push(reviewData[event]);
                    }
                }
                eventList.ss.sort(function(a,b){return a.startTime - b.startTime;});
                eventList.mini.sort(function(a,b){return a.startTime - b.startTime;});
                return eventList;
            }
            function focus(){
                var foc = document.getElementsByClassName('storyFocused')[0];
                if(foc){
                    foc.scrollIntoView({behavior: "smooth", block: "center"});
                }
                console.log('focused!')
            }

            const lr = Vue.createApp({
                data(){
                    return{
                        data: {eventName: '< - ' + i18n.selectStory[l]},
                        path: urlParams.get('f'),
                        lang: l,
                        doctor: doctor,
                        i18n: i18n
                    }
                },
                updated(){
                    if(urlParams.get('warp')){
                        var tgt = document.getElementById(urlParams.get('warp'));
                        if(tgt){
                            tgt.scrollIntoView({behavior: "smooth", block: "center"});
                            tgt.style.setProperty("background-color", '#f4433633');
                        }
                    };
                    focus();
                },
                methods:{
                    jumpTo(id){
                        var optLine = document.getElementById(id);
                        optLine.scrollIntoView({behavior: "smooth", block: "center"});
                    },
                    changeColor(id,color){
                        var optLine = document.getElementById(id);
                        setInterval(optLine.style.setProperty("background-color", color),500);
                    },
                    getURL(l,path,line){
                        return '?l=' + l + '&f=' + path + '&warp=line' + line;
                    },
                    parseContent(content){
                        if(content){
                            content = content.replaceAll('{@nickname}',this.doctor);
                            content = content.replaceAll('\\n','<br/>')
                            content = content.replace(color_re,color_sub);
                        }
                        return content;
                    }
                }
            });
            const storylist = lr.mount('#list-rendering');

            
            const sdb = Vue.createApp({
                data(){
                    return{
                        data: {},
                        chardict: {},
                        eventList: {},
                        lang: l,
                        sl: storylist,
                        i18n: i18n,
                        showMenu: true
                    }
                },
                methods:{
                    langSwitch(langCode){
                        req = 'l='+langCode;
                        window.location.search = req;
                    }
                },
                components:{
                    eventmenu:{
                        template:'#eventmenu',
                        props:['event','eventid','sl','lang','showMenu'],
                        emits:['hidemenu','focusStory'],
                        data(){
                            return{
                                collapsed: true
                            }
                        },
                        components:{
                            storymenu:{
                                template:'#storymenu',
                                props:['event','eventid','sl','lang','story'],
                                emits:['hidemenu','focusstory','unfoldevent'],
                                data(){
                                    return{
                                        focused: false
                                    }
                                },
                                mounted(){
                                    if(urlParams.get('f') == this.story.storyTxt){
                                        this.focused = true;
                                        this.$emit('unfoldevent');
                                    }
                                },
                                methods:{
                                    loadStory(sl, lang, path){
                                        req = 'l='+lang;
                                        req = req + '&f=' + path;
                                        window.location.search = req;
                                    }
                                }
                            }
                        }
                    }

                }
            })
            const menu = sdb.mount('#sidebar');
            $.getJSON('https://raw.githubusercontent.com/Kengxxiao/ArknightsGameData/master/'+l+'/gamedata/excel/story_review_table.json').done(function(s){menu.data = s;$.getJSON("https://raw.githubusercontent.com/050644zf/ArknightsStoryJson/main/"+l+'/chardict.json').done(function(t){menu.chardict = t;menu.eventList = getEventList(menu.data, menu.chardict);})})
            
            if(urlParams.get('f')){
                $.getJSON("https://raw.githubusercontent.com/050644zf/ArknightsStoryJson/main/"+l+'/gamedata/story/'+urlParams.get('f')+'.json').done(function(s){storylist.data = s;}).fail(function(){storylist.data = {eventName: 'Error on loading json file: '+ urlParams.get('f') + '!'};});

            }
            

        </script>
              

        

    </body>
</html>